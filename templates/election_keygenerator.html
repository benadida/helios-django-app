{% extends "helios/templates/cryptobase.html" %}
{% block content %}
<script language="javascript">

var PUBLIC_KEY, PROOF;

$(document).ready(function() {
    $('#generator').hide();
    BigInt.setup(function() {
        ELGAMAL_PARAMS = ElGamal.Params.fromJSONObject({{eg_params_json|safe}});
        $('#waiting_message').hide();
        $('#generator').show();
    });
});

function clear_keys() {
    $('#sk_textarea').val("");
    $('#pk_textarea').val("");
    $('#sk_form').hide();
    $('#pk_form').hide();
    $('#buttons').show();
    $('#clear_button').hide();
}

function generate_keypair() {
    var secret_key;
    
    $('#buttons').hide();
    
    try {
        secret_key = ELGAMAL_PARAMS.generate();
    } catch (e) {
        alert(e);
    }
    
    // generate PoK of secret key
    PROOF = secret_key.proveKnowledge(ElGamal.fiatshamir_dlog_challenge_generator);
    PUBLIC_KEY = secret_key.pk;

    $('#sk_textarea').val(jQuery.toJSON(secret_key));
    var pk_val = jQuery.toJSON({'pok': PROOF, 'public_key': PUBLIC_KEY});
    $('#pk_textarea').val(pk_val);
    $('#pk_hash').html(b64_sha256(jQuery.toJSON(PUBLIC_KEY)));

    $('#clear_button').show();
    show_sk();
}

function show_sk() {
    $('#sk_form').show();
}

function show_pk() {
    $('#sk_form').hide();
    $('#pk_hash').show();
    $('#pk_form').show();
}

$(document).ready(function() {
    clear_keys();
});

</script>

<h2 class="title">{{election.name}} &mdash; Trustee {{trustee.name}} &mdash; Keypair Generator</h2>

<p>
  This is a trustee keypair generator for your election.
</p>

<p id="waiting_message">
  Please wait for the generator to load...
</p>

<p id="generator">

<span id="buttons"><button onclick="generate_keypair(); return false;" id="generate_button">Generate Election Keys</button></span>

<span id="clear_button">
Your key has been generated, but you may choose to<br />clear it from memory and start from scratch if you prefer.<br />
<button onclick="clear_keys(); return false;">Clear Keys</button>
</span>

<form id="sk_form">
<h3>Your Secret Key</h3>

<p>
    Copy this secret key to a safe place.
</p>
<textarea id="sk_textarea" cols="80" rows="10" readonly="readonly">
</textarea>
<br />
<button onclick="show_pk(); return false;">ok, I've copied this to a safe place</button>
</form>

<form method="post" id="pk_form" action="{% url helios.views.trustee_upload_pk election.uuid, trustee.uuid %}">
<h3>Your Public Key</h3>
<p>
    Now that you have copied your private key to a safe place, it's time to upload the public key to the server.
</p>
<p>
    The fingerprint of your public key is: <tt id="pk_hash" style="font-size: 1.5em; font-weight: bold;"></tt>.<br />
    You may want to save this to confirm that your public key was properly stored by the server.<br />
    (Your public key is not currently being displayed because you do not need to save it, the fingerprint is sufficient.)
</p>
<textarea id="pk_textarea" name="public_key_json" cols="80" rows="10" style="display:none;">
</textarea>
<input type="submit" value="Upload your public key">
</form>

<div id="applet_div"></div>
<br /><br />
{% endblock %}